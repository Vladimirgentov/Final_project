name: YC create VM and deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Load .env.yc
        shell: bash
        run: |
          set -euo pipefail
          sed -E 's/^\s*export\s+//' .env.yc | grep -vE '^\s*#' | grep -vE '^\s*$' >> "$GITHUB_ENV"

      - name: Install yc cli (no sudo)
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i "$HOME/yandex-cloud"
          echo "$HOME/yandex-cloud/bin" >> "$GITHUB_PATH"
          yc version

      - name: Auth yc cli with service account key
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.config/yandex-cloud
          echo '${{ secrets.YC_SA_KEY_JSON }}' > ~/.config/yandex-cloud/sa-key.json
          yc config set service-account-key ~/.config/yandex-cloud/sa-key.json
          yc config set cloud-id "$YC_CLOUD_ID"
          yc config set folder-id "$YC_FOLDER_ID"
          yc config list

      - name: Prepare SSH keys files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/cloudlink_rsa
          echo "${{ secrets.SSH_PUBLIC_KEY }}"  > ~/.ssh/cloudlink_rsa.pub
          chmod 600 ~/.ssh/cloudlink_rsa
          chmod 644 ~/.ssh/cloudlink_rsa.pub
          echo "SSH_PRIVATE_KEY=$HOME/.ssh/cloudlink_rsa" >> "$GITHUB_ENV"
          echo "SSH_PUBLIC_KEY=$HOME/.ssh/cloudlink_rsa.pub" >> "$GITHUB_ENV"

      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Ensure scripts executable
        run: chmod +x scripts/prepare.sh scripts/run.sh scripts/tests.sh

      - name: Build Docker image
        run: ./scripts/prepare.sh :contentReference[oaicite:1]{index=1}

      - name: Create VM + deploy
        shell: bash
        run: |
          set -euo pipefail
          IP="$(./scripts/run.sh | tail -n 1)"
          echo "VM_IP=$IP" >> "$GITHUB_ENV"
          echo "VM IP: $IP"


      - name: Run API tests on VM
        shell: bash
        run: |
          set -euo pipefail
          export BASE_URL="http://${VM_IP}:8080"
          ./scripts/tests.sh :contentReference[oaicite:3]{index=3}

      - name: Result
        run: echo "Deployed to http://${VM_IP}:8080"
