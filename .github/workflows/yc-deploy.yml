name: YC create VM and deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug workflow identity
        shell: bash
        run: |
          set -euo pipefail
          echo "Workflow: $GITHUB_WORKFLOW"
          echo "Job: $GITHUB_JOB"
          echo "Ref: $GITHUB_REF"
          echo "SHA: $GITHUB_SHA"

      - name: Load .env.yc
        shell: bash
        run: |
          set -euo pipefail
          sed -E 's/^\s*export\s+//' .env.yc | grep -vE '^\s*#' | grep -vE '^\s*$' >> "$GITHUB_ENV"

      - name: Install yc cli (no sudo, stable)
        shell: bash
        run: |
          set -euo pipefail

          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i "$HOME/yandex-cloud" || true

          echo "$HOME/yandex-cloud/bin" >> "$GITHUB_PATH"

          if [ ! -x "$HOME/yandex-cloud/bin/yc" ]; then
            echo "yc binary not found at $HOME/yandex-cloud/bin/yc"
            ls -la "$HOME/yandex-cloud" || true
            ls -la "$HOME/yandex-cloud/bin" || true
            exit 1
          fi

          "$HOME/yandex-cloud/bin/yc" version



      - name: Auth yc cli with service account key
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.config/yandex-cloud
          echo '${{ secrets.YC_SA_KEY_JSON }}' > ~/.config/yandex-cloud/sa-key.json
          yc config set service-account-key ~/.config/yandex-cloud/sa-key.json
          yc config set cloud-id "$YC_CLOUD_ID"
          yc config set folder-id "$YC_FOLDER_ID"
          yc config list

      - name: Prepare SSH keys (from base64)
        shell: bash
        env:
          SSH_PRIVATE_KEY_B64: ${{ secrets.SSH_PRIVATE_KEY_B64 }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh

          printf "%s" "$SSH_PRIVATE_KEY_B64" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh-keygen -y -f ~/.ssh/deploy_key > ~/.ssh/deploy_key.pub
          chmod 644 ~/.ssh/deploy_key.pub

          echo "SSH_PRIVATE_KEY=$HOME/.ssh/deploy_key" >> "$GITHUB_ENV"
          echo "SSH_PUBLIC_KEY=$HOME/.ssh/deploy_key.pub" >> "$GITHUB_ENV"

      - name: Debug SSH key file
        shell: bash
        run: |
          set -euo pipefail
          wc -c ~/.ssh/deploy_key
          head -n 1 ~/.ssh/deploy_key
          tail -n 1 ~/.ssh/deploy_key
          ssh-keygen -lf ~/.ssh/deploy_key.pub


    
      - name: Debug SSH public key
        shell: bash
        run: |
          set -euo pipefail
          echo "Public key (first 120 chars):"
          head -c 120 ~/.ssh/deploy_key.pub; echo
          echo "Fingerprint:"
          ssh-keygen -lf ~/.ssh/deploy_key.pub
    

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq unzip curl

      - name: Ensure scripts executable
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/prepare.sh scripts/run.sh scripts/tests.sh

      - name: Build Docker image
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/prepare.sh

      - name: Create VM + deploy
        shell: bash
        run: |
          set -euo pipefail
          IP="$(./scripts/run.sh | tail -n 1)"
          echo "VM_IP=$IP" >> "$GITHUB_ENV"
          echo "VM IP: $IP"

      - name: Run API tests on VM
        shell: bash
        run: |
          set -euo pipefail
          export BASE_URL="http://${VM_IP}:8080"
          ./scripts/tests.sh

      - name: Result
        shell: bash
        run: |
          set -euo pipefail
          echo "Deployed to http://${VM_IP}:8080"
